---
- name: Add control host in automationcontroller group
  ansible.builtin.add_host:
    name: "{{ groups['bastions'][0] }}"
    groups: automationcontroller

- name: Install Automation controller
  when: install_automationcontroller | bool
  block:
    - name: Install automation controller from role
      ansible.builtin.include_role:
        name: deploy_automationcontroller

    - name: Clean up
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - "/tmp/automationcontroller_installer"
        - "/tmp/automationcontroller.tar.gz"

    - name: Enable offline automation controller repo
      community.general.ini_file:
        path: "/etc/yum.repos.d/*.repo"
        section: ansible-automation-platform
        option: enabled
        value: 1

    - name: Install ansible core & navigator
      ansible.builtin.dnf:
        name:
          - ansible-core
          - ansible-navigator
        state: present

    - name: Copy ansible-navigator file
      ansible.builtin.copy:
        src: ./files/ansible-navigator.yml
        dest: "/home/{{ student_name }}/.ansible-navigator.yml"
        owner: "{{ student_name }}"
        group: "{{ student_name }}"
        mode: '0644'

    - name: Include automation configuration loader
      when: configure_automationcontroller | bool
      ansible.builtin.include_role:
        name: automation_platform_loader

    - name: Include cert generator
      when: enable_letsencyrpt_cert | bool
      ansible.builtin.include_role:
        name: aap_controller_cert_issue

- name: Vscode configuration block
  when: install_vscode_server | bool
  block:
    - name: Install vscode server
      ansible.builtin.include_role:
        name: vscode-server

    - name: Clean up
      ansible.builtin.file:
        path: "/tmp/code-server.rpm"
        state: absent

    - name: Insert vscode proxy conf in nginx
      when: install_automationcontroller | bool
      ansible.builtin.blockinfile:
        path: /etc/nginx/conf.d/automation-controller.nginx.conf
        marker: "    # ANSIBLE MANAGED BLOCK"
        insertbefore: '.*location \/ \{.*'
        block: "{{ lookup('file', './files/vscode_nginx.conf') }}"

    - name: Restart nginx
      when: install_automationcontroller | bool
      ansible.builtin.service:
        name: nginx
        state: restarted
